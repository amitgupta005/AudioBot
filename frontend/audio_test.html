<!DOCTYPE html>
<html>

<head>
    <title>Audio Bot Test</title>
</head>

<body>

    <h2>Audio Bot Test</h2>

    <button id="start">Start Recording</button>
    <button id="stop">Stop & Send</button>

    <p id="status">Idle</p>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        const ws = new WebSocket("ws://localhost:8000/ws");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
            document.getElementById("status").innerText = "WebSocket connected";
        };

        ws.onmessage = async (event) => {
            if (event.data instanceof ArrayBuffer) {
                const audioBlob = new Blob([event.data], { type: "audio/wav" });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            }
        };

        document.getElementById("start").onclick = async () => {
            audioChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            document.getElementById("status").innerText = "Recording...";
        };

        document.getElementById("stop").onclick = () => {
            mediaRecorder.stop();

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const audioBuffer = await audioBlob.arrayBuffer();

                // Send control message
                ws.send(JSON.stringify({
                    type: "audio",
                    conversation_id: "voice-test-1"
                }));

                // Send audio bytes
                ws.send(audioBuffer);

                document.getElementById("status").innerText = "Sent audio";
            };
        };
    </script>

</body>

</html>